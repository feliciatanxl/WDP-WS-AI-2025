<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment | Fresh Farm</title>
    <link rel="icon" type="image/png" href="image/Green Minimalist Leaf Plant Logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="payment.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="image/Green Minimalist Leaf Plant Logo.png" alt="Logo Png" height="70">
            </a>
            <div class="ms-auto d-flex align-items-center">
                <a href="orders.html" class="text-decoration-none text-muted me-3">
                    <i class="bi bi-arrow-left"></i> Back to Cart
                </a>
                <span class="text-success fw-bold"><i class="bi bi-shield-lock-fill"></i> Secure Checkout</span>
            </div>
        </div>
    </nav>

    <main class="page-content container pt-5" style="margin-top: 80px;">
        <div class="row g-5 justify-content-center">

            <div class="col-lg-7">
                <div class="checkout-header mb-4">
                    <h2 class="fw-bold">Shipping & Payment</h2>
                    <p class="text-muted">Please enter your details to complete the order.</p>
                </div>

                <form id="checkout-form" novalidate>
                    <div class="form-section bg-white p-4 rounded-4 shadow-sm mb-4 border">
                        <h5 class="fw-bold mb-4"><i class="bi bi-truck text-success me-2"></i>Delivery Details</h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Email Address</label>
                                <input type="email" id="input-email" class="form-control modern-input" placeholder="name@example.com" required>
                                <div class="invalid-feedback">Invalid email.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Full Name</label>
                                <input type="text" id="input-name" class="form-control modern-input" placeholder="Receiver Name" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted fw-bold">Delivery Address</label>
                                <textarea id="input-address" class="form-control modern-input" rows="2" placeholder="Unit, Street, Postal Code" required></textarea>
                                <div class="invalid-feedback">Address too short.</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section bg-white p-4 rounded-4 shadow-sm mb-4 border">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0"><i class="bi bi-credit-card text-success me-2"></i>Payment Method</h5>
                            <div class="payment-icons text-muted fs-5">
                                <i class="bi bi-credit-card-2-front-fill me-2"></i>
                                <i class="bi bi-paypal"></i>
                            </div>
                        </div>

                        <div class="mb-3 position-relative">
                            <label class="form-label small text-muted fw-bold">Card Number</label>
                            <i class="bi bi-credit-card-2-back position-absolute top-50 start-0 translate-middle-y ms-3 mt-3 text-muted" style="z-index:5;"></i>
                            <input type="text" id="input-card" class="form-control modern-input ps-5" placeholder="0000 0000 0000 0000" maxlength="19" required>
                            <div class="invalid-feedback">Invalid card number.</div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Expiry Date</label>
                                <input type="text" id="input-expiry" class="form-control modern-input text-center" placeholder="MM / YY" maxlength="5" required>
                            </div>
                            <div class="col-md-6 position-relative">
                                <label class="form-label small text-muted fw-bold">CVV <i class="bi bi-question-circle-fill text-muted ms-1" title="3 digits on back"></i></label>
                                <input type="password" id="input-cvv" class="form-control modern-input text-center" placeholder="123" maxlength="3" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-lg-5">
                <div class="summary-panel bg-white p-4 rounded-4 shadow-sm border sticky-top" style="top: 100px; z-index: 1;">
                    <h4 class="fw-bold mb-4">Order Summary</h4>

                    <div id="mini-cart-items" class="mb-4" style="max-height: 200px; overflow-y: auto;">
                    </div>

                    <div class="input-group mb-3">
                        <input type="text" id="input-promo" class="form-control modern-input" placeholder="Promo Code (e.g. FRESH10)">
                        <button class="btn btn-dark px-4" type="button" id="btn-apply-promo">Apply</button>
                    </div>
                    <small id="promo-message" class="d-block mb-3"></small>

                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span>Subtotal</span><span id="subtotal-display">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-success fw-bold" id="discount-row" style="display:none;">
                        <span>Discount</span><span id="discount-display">-$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span>Shipping</span><span class="text-success">Free</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-muted">
                        <span>GST (9%)</span><span id="tax-display">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fs-5 fw-bold">Total to Pay</span>
                        <span class="fs-2 fw-bold text-success" id="total-display">$0.00</span>
                    </div>

                    <button type="submit" form="checkout-form" class="btn btn-success w-100 py-3 fw-bold shadow rounded-pill fs-5 btn-pay">
                        Confirm Payment <i class="bi bi-lock-fill ms-2"></i>
                    </button>
                    <div class="text-center mt-3 text-muted small">
                        <i class="bi bi-shield-check me-1"></i> SSL Encrypted Transaction
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="custom-footer mt-5">
        <p class="text-center text-muted py-4 mb-0">&copy; 2025 WEB DEVELOPMENT PROJECT TEAM AI.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GST_RATE = 0.09;
            let cart = JSON.parse(localStorage.getItem('farmCart')) || [];
            let discountMultiplier = 1;

            // Elements
            const miniCartItems = document.getElementById('mini-cart-items');
            const subtotalDisplay = document.getElementById('subtotal-display');
            const taxDisplay = document.getElementById('tax-display');
            const totalDisplay = document.getElementById('total-display');
            const discountRow = document.getElementById('discount-row');
            const discountDisplay = document.getElementById('discount-display');

            // --- 1. Render Summary Data ---
            function renderSummary() {
                if (cart.length === 0) window.location.href = 'orders.html';

                miniCartItems.innerHTML = '';
                let subtotal = 0;

                cart.forEach(item => {
                    const priceNum = parseFloat(item.price.replace('$', ''));
                    subtotal += priceNum * item.qty;

                    // Simple mini-item view
                    miniCartItems.innerHTML += `
                            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom small">
                                <div>
                                    <span class="fw-bold">${item.qty}x</span> ${item.name}
                                </div>
                                <span>$${(priceNum * item.qty).toFixed(2)}</span>
                            </div>
                        `;
                });

                updateFinancials(subtotal);
            }

            function updateFinancials(subtotal) {
                let discountAmount = 0;
                if (discountMultiplier < 1) {
                    discountAmount = subtotal * (1 - discountMultiplier);
                    discountRow.style.display = 'flex';
                    discountDisplay.textContent = '-$' + discountAmount.toFixed(2);
                } else {
                    discountRow.style.display = 'none';
                }

                const discountedSubtotal = subtotal - discountAmount;
                const gst = discountedSubtotal * GST_RATE;
                const total = discountedSubtotal + gst;

                subtotalDisplay.textContent = '$' + subtotal.toFixed(2);
                taxDisplay.textContent = '$' + gst.toFixed(2);
                totalDisplay.textContent = '$' + total.toFixed(2);
            }

            // --- 2. Form Formatters & Validation (Moved from orders.html) ---
            const cardInput = document.getElementById('input-card');
            const expiryInput = document.getElementById('input-expiry');
            const cvvInput = document.getElementById('input-cvv');

            cardInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '').substring(0, 16);
                e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
                validateField(e.target, value.length === 16);
            });

            expiryInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 4);
                e.target.value = value;
                validateField(e.target, value.length === 5);
            });

            cvvInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '').substring(0, 3);
                e.target.value = value;
                validateField(e.target, value.length === 3);
            });

            document.getElementById('btn-apply-promo').addEventListener('click', () => {
                const input = document.getElementById('input-promo');
                const msg = document.getElementById('promo-message');
                if (input.value.toUpperCase() === 'FRESH10') {
                    discountMultiplier = 0.9;
                    msg.textContent = "10% discount applied!"; msg.className = "d-block mb-3 text-success small fw-bold";
                } else {
                    discountMultiplier = 1;
                    msg.textContent = "Invalid code."; msg.className = "d-block mb-3 text-danger small";
                }
                renderSummary();
            });

            function validateField(input, condition) {
                if (condition) { input.classList.remove('is-invalid'); input.classList.add('is-valid'); return true; }
                else { input.classList.remove('is-valid'); input.classList.add('is-invalid'); return false; }
            }

            // --- 3. Submit Logic ---
            document.getElementById('checkout-form').addEventListener('submit', (e) => {
                e.preventDefault();

                const isEmailValid = validateField(document.getElementById('input-email'), /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(document.getElementById('input-email').value));
                const isNameValid = validateField(document.getElementById('input-name'), document.getElementById('input-name').value.trim().length >= 3);
                const isAddressValid = validateField(document.getElementById('input-address'), document.getElementById('input-address').value.trim().length >= 10);
                const isCardValid = validateField(cardInput, cardInput.value.replace(/\s/g, '').length === 16);
                const isExpiryValid = validateField(expiryInput, expiryInput.value.length === 5);
                const isCvvValid = validateField(cvvInput, cvvInput.value.length === 3);

                if (isEmailValid && isNameValid && isAddressValid && isCardValid && isExpiryValid && isCvvValid) {
                    const btn = document.querySelector('.btn-pay');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
                    setTimeout(() => {
                        alert("Payment Successful! Order placed.");
                        localStorage.removeItem('farmCart');
                        window.location.href = 'review.html';
                    }, 2000);
                } else {
                    // Shake effect for errors
                    const panel = document.querySelector('.summary-panel');
                    panel.style.animation = "shake 0.5s"; setTimeout(() => panel.style.animation = "none", 500);
                }
            });

            renderSummary();
        });
    </script>
</body>
</html>